---
title: "Batch PDF to JPG Conversion (Pure Python)"
format: html
---

# Overview

This script uses **PyMuPDF** and **Pillow** to convert PDFs to JPGs.  
It checks if a PDF is blank (no text and empty white pages). If blank, the PDF is removed.  

---

```{bash}
which python
python --version
```

```{r}
library(reticulate)
use_python("/usr/bin/python3", required = TRUE)
# e.g. use_python("/nas/longleaf/apps/python/3.11/bin/python3", required = TRUE)
```


# Conversion Script

```{python}
import fitz  # PyMuPDF
from PIL import Image, ImageChops
from pathlib import Path

# Path to biomarker list
biomarker_list = "biomarkernames.txt"

# Read biomarker names
with open(biomarker_list, "r", encoding="utf-8") as f:
    biomarkers = [line.strip().strip('"') for line in f if line.strip()]

def is_blank_pdf(pdf_path: Path) -> bool:
    """Check if PDF is blank (no text, no significant graphics)."""
    try:
        doc = fitz.open(pdf_path)
        if len(doc) == 0:
            return True
        
        for page in doc:
            # Check text
            if page.get_text().strip():
                return False
            
            # Render image at low resolution
            pix = page.get_pixmap(dpi=30)
            img = Image.frombytes("RGB", [pix.width, pix.height], pix.samples)
            
            # Compare to a white background
            bg = Image.new("RGB", img.size, (255, 255, 255))
            diff = ImageChops.difference(img, bg)
            if diff.getbbox() is not None:  # Something non-white found
                return False
        return True
    except Exception:
        return True

def pdf_to_jpgs(pdf_path: Path, output_folder: Path):
    """Convert each page of PDF into JPGs."""
    doc = fitz.open(pdf_path)
    pdf_name = pdf_path.stem
    subfolder = output_folder / pdf_name
    subfolder.mkdir(parents=True, exist_ok=True)

    for i, page in enumerate(doc, start=1):
        pix = page.get_pixmap(dpi=300)
        img_path = subfolder / f"{pdf_name}_page_{i:03d}.jpg"
        pix.save(str(img_path))
    return subfolder

# Process all biomarkers
for biomarker in biomarkers:
    input_folder = Path(f"/work/users/m/c/mcgeet/DMETpaper/figs/{biomarker}/full")
    output_folder = Path(f"/work/users/m/c/mcgeet/DMETpaper/figures/{biomarker}/jpgs/boxcox")

    print(f"Processing biomarker: {biomarker}")
    output_folder.mkdir(parents=True, exist_ok=True)

    for pdf_file in input_folder.glob("*.pdf"):
        if is_blank_pdf(pdf_file):
            print(f"  ‚ö†Ô∏è Removing blank PDF: {pdf_file.name}")
            pdf_file.unlink()
            continue

        print(f"  üìÑ Converting {pdf_file.name} ...")
        saved_to = pdf_to_jpgs(pdf_file, output_folder)
        print(f"  ‚úÖ Saved images in {saved_to}")

print("üéâ All conversions complete!")
```
